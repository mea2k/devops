# PYMONITOR - мониторинг метрик операционной системы

## Зависимости

Программа написана на языке программирования Python3.

__Требуемые библиотеки:__

`os` - для доступа к файлам и каталогам журналов

`errno` - для отлова ошибок при доступе к файловой системе

`json` - для фориррования JSON-даннвх и запись из в файл журнала

`datetime` - для получения текущего времени

`time` - для получения времени в UNIX-формате

`re` - для поиска метрик и их щначений в файлах


## Описание

Прошрамма анализирует содержимое файлов в папке /proc и извлекает из них метрики. Далее метрики объединяются в JSON-объект и сохраняются в файл `LOG_PATH/LOG_PREFIX<yyyy-mm-dd>LOG_SUFFIX.log`.

На текущий момент поддерживаются следующие типы метрик:

- `cpustat` - всё про ядра CPU (`/proc/cpustat`)

- `loadavg` - среднее время работы и простоя CPU (`/proc/loadavg`)

- `meminfo` - информация по использованию оперативной памяти (`/proc/meminfo`)

- `uptime` - время работы системы с момента перезагрузки (`/proc/uptime`)


## Структура модуля

Программа состоит из следующих моделей:

1. Основной модуль ([main.py](main.py)) - запуск всех сборщиков метрик и запись информации в журнал

2. Сборщики:

  - _cpustat_ ([cpustat/main.py](cpustat/main.py))
  
  - _loadavg_ ([loadavg/main.py](loadavg/main.py))

  - _meminfo_ ([meminfo/main.py](meminfo/main.py))

  - _uptime_ ([uptime/main.py](uptime/main.py))


## Формат журнала

Журнал создаетсмя автоматически по пути `LOG_PATH` (по умолчанию, `/var/log/pymonitor`)

Название файла: `LOG_PREFIX<yyyy-mm-dd>LOG_DUFFIX.log` (по умолчанию, `awesome_monitoring_yyyy-mm-dd.log`)

Структура записи:

`<timestamp> - {JSON_data} `

__Формат JSON_data:__
```
{
	'time':			дата и время в ISO-формате (string),
	'timestamp':	временная метка в UNIX-формате (int),
	'cpu_data':		данные метрик по использованию CPU (из модуля cpustat),
	'uptime':		данные метрик по работе системы (из модуля uptime),
	'loadavg':		данные метрик по средней загрузке и простою CPU (из модуля loadavg),
	'meminfo':		данные метрик по использованию оперативной памяти (из модуля meminfo)
}
```

Пример содердимого журнала:
```
1734302332 - {"time": "2024-12-15T22:38:52.725903", "timestamp": 1734302332, "cpu_data": {"cpu_total": {"name": "cpu", "user": 102000, "nice": 300, "system": 269400, "idle": 122447800, "iowait": 1712500, "irq": 0, "softirq": 42600, "steal": 0, "guest": 0}, "cpus": [{"name": "cpu0", "user": 50300, "nice": 200, "system": 127600, "idle": 61055300, "iowait": 1005100, "irq": 0, "softirq": 20200, "steal": 0, "guest": 0}, {"name": "cpu1", "user": 51700, "nice": 0, "system": 141700, "idle": 61392500, "iowait": 707300, "irq": 0, "softirq": 22400, "steal": 0, "guest": 0}], "intr": {"total": 64531000, "counters": [400, 350900, 0, 0, 0, 0, 0, 0, 100, 0, 0, 0, 472700, 0, 0, 0, 3082600, 2161600, 6800, 776700, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 320800, 87800, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]}, "ctxt": 1120094, "btime": 1734296088, "processes": 1734296088, "procs_running": 4, "procs_blocked": 0, "softirq": [950615, 1, 331273, 1217, 7811, 26055, 0, 3067, 331446, 0, 249745]}, "uptime": {"total": 6244.31, "idle": 11647.12}, "loadavg": {"loadavg_1m": 0.01, "loadavg_5m": 0.02, "loadavg_15m": 0.0, "current_procs": "2", "total_procs": "339", "last_pid": 5328}, "meminfo": {"MemTotal": {"value": "1986320", "unit": "kB"}, "MemFree": {"value": "862960", "unit": "kB"}, "MemAvailable": {"value": "1211976", "unit": "kB"}, "Buffers": {"value": "41256", "unit": "kB"}, "Cached": {"value": "414444", "unit": "kB"}, "SwapCached": {"value": "0", "unit": "kB"}, "Active": {"value": "483212", "unit": "kB"}, "Inactive": {"value": "309848", "unit": "kB"}, "Active(anon)": {"value": "346564", "unit": "kB"}, "Inactive(anon)": {"value": "700", "unit": "kB"}, "Active(file)": {"value": "136648", "unit": "kB"}, "Inactive(file)": {"value": "309148", "unit": "kB"}, "Unevictable": {"value": "18820", "unit": "kB"}, "Mlocked": {"value": "18820", "unit": "kB"}, "SwapTotal": {"value": "2097148", "unit": "kB"}, "SwapFree": {"value": "2097148", "unit": "kB"}, "Dirty": {"value": "376", "unit": "kB"}, "Writeback": {"value": "0", "unit": "kB"}, "AnonPages": {"value": "356172", "unit": "kB"}, "Mapped": {"value": "163012", "unit": "kB"}, "Shmem": {"value": "1608", "unit": "kB"}, "KReclaimable": {"value": "68864", "unit": "kB"}, "Slab": {"value": "165568", "unit": "kB"}, "SReclaimable": {"value": "68864", "unit": "kB"}, "SUnreclaim": {"value": "96704", "unit": "kB"}, "KernelStack": {"value": "7424", "unit": "kB"}, "PageTables": {"value": "4296", "unit": "kB"}, "NFS_Unstable": {"value": "0", "unit": "kB"}, "Bounce": {"value": "0", "unit": "kB"}, "WritebackTmp": {"value": "0", "unit": "kB"}, "CommitLimit": {"value": "3090308", "unit": "kB"}, "Committed_AS": {"value": "1449828", "unit": "kB"}, "VmallocTotal": {"value": "34359738367", "unit": "kB"}, "VmallocUsed": {"value": "22004", "unit": "kB"}, "VmallocChunk": {"value": "0", "unit": "kB"}, "Percpu": {"value": "129024", "unit": "kB"}, "HardwareCorrupted": {"value": "0", "unit": "kB"}, "AnonHugePages": {"value": "0", "unit": "kB"}, "ShmemHugePages": {"value": "0", "unit": "kB"}, "ShmemPmdMapped": {"value": "0", "unit": "kB"}, "FileHugePages": {"value": "0", "unit": "kB"}, "FilePmdMapped": {"value": "0", "unit": "kB"}, "CmaTotal": {"value": "0", "unit": "kB"}, "CmaFree": {"value": "0", "unit": "kB"}, "HugePages_Total": {"value": "0", "unit": ""}, "HugePages_Free": {"value": "0", "unit": ""}, "HugePages_Rsvd": {"value": "0", "unit": ""}, "HugePages_Surp": {"value": "0", "unit": ""}, "Hugepagesize": {"value": "2048", "unit": "kB"}, "Hugetlb": {"value": "0", "unit": "kB"}, "DirectMap4k": {"value": "173952", "unit": "kB"}, "DirectMap2M": {"value": "1923072", "unit": "kB"}, "DirectMap1G": {"value": "0", "unit": "kB"}}}
```


## Запуск

1. Копирование файлов с кодом программы в систему (например, в `/var/opt/pymonitor`)

2. Настройка требуемых переменных `LOG_PATH`, `LOG_PREFIX`, `LOG_SUFFIX` ([main.py](main.py#L13))

3. Копирование файла [pymonitor.service](pymonitor.service) в папку `/etc/systemd/system/`

4. Редактирвоание файла `/etc/systemd/system/pymonitor.service`: изменение пути зарпуска `ExecStart` _(при необходимости)_

5. Выполнение команды
```
sudo systemctl daemon-reload
```

6. Проверка корректности запуска службы
```
sudo systemctl start pymonitor
sudo systemctl status pymonitor
```

7. Проверка, что появился файл журнала по пути `/var/log/pymonitor/awesome_monitoring_yyyy-mm-dd.log`

8. Добавление записи в cron для запуска программы каждую минуту:

	a) Выполнитиь команду `sudo crontab -e` и добавить строку
	```
	*/1 * * * * systemctl start pymonitor
	```
	
	b) Проверить, что данные в crontab записались
	```
	sudo crontab -l
	```
	
	с) Проверить, что журнал ежеминутно пополняется новыми записями (`/var/log/pymonitor/`)

	

# Copyright

Copyright (c) DJ Eugene aka mea2k, 2024
