---
  - name: Install python3.10
    hosts: clickhouse,vector
    gather_facts: false
    tasks:
      - name: Install Python3.10
        block:
        - name: set pytnon3.8 as default interpreter
          raw: sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.8 1 
        - name: update repository 
          raw: sudo apt-get update && sudo add-apt-repository -y ppa:deadsnakes/ppa
        - name: install python3
          raw: sudo apt-get install -y python3.10
        - name: set pytnon3.10 as default interpreter
          raw: sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.10 2
        - name: install python3-apt 
          raw: sudo apt install --reinstall -y python3-apt
        




  - name: Install Clickhouse
    hosts: clickhouse
    handlers:
      - name: Start clickhouse service
        become: true
        ansible.builtin.service:
          name: clickhouse-server
          state: restarted
    tasks:
      - name: Mess with clickhouse distrib
        block:
          - name: Get clickhouse distrib
            ansible.builtin.get_url:
              url: "https://packages.clickhouse.com/rpm/stable/{{ item }}-{{ clickhouse_version }}.x86_64.rpm"
              dest: "./{{ item }}-{{ clickhouse_version }}.rpm"
              mode: "0644"
            with_items: "{{ clickhouse_packages }}"
        rescue:
          - name: Get clickhouse distrib (rescue)
            ansible.builtin.get_url:
              url: "https://packages.clickhouse.com/rpm/stable/clickhouse-common-static-{{ clickhouse_version }}.x86_64.rpm"
              dest: "./clickhouse-common-static-{{ clickhouse_version }}.rpm"
              mode: "0644"
      - name: Install clickhouse packages
        become: true
        ansible.builtin.dnf:
          name:
            - clickhouse-common-static-{{ clickhouse_version }}.rpm
            - clickhouse-client-{{ clickhouse_version }}.rpm
            - clickhouse-server-{{ clickhouse_version }}.rpm
          disable_gpg_check: true
        notify: Start clickhouse service
      - name: Flush handlers to restart clickhouse
        ansible.builtin.meta: flush_handlers
      - name: Create database
        ansible.builtin.command: "clickhouse-client -q 'create database logs;'"
        become: true
        register: create_db
        failed_when: create_db.rc != 0 and create_db.rc != 82
        changed_when: create_db.rc == 0

  - name: Install vector
    hosts: vector
    handlers:
      - name: Start vector service
        become: true
        ansible.builtin.service:
          name: vector
          state: restarted
          
    tasks:
      - name: Get vector distrib
        ansible.builtin.get_url:
          url: "https://packages.timber.io/vector/{{ vector_version }}/vector-{{ vector_version }}-1.x86_64.rpm"
          dest: "./vector-{{ vector_version }}.rpm"
          mode: "0644"
        notify: Start vector service

      - name: Install vector packages
        become: true
        ansible.builtin.dnf:
          name:
            - vector-{{ vector_version }}.rpm
          disable_gpg_check: true
      - name: Flush handlers to restart vector
        ansible.builtin.meta: flush_handlers

      - name: Configure Vector | ensure what directory exists
        ansible.builtin.file:
          path: "{{ vector_config_dir }}"
          state: directory
          mode: "0755"
      - name: Configure Vector | Template config
        ansible.builtin.template:
          src: "template/vector.yml.j2"
          dest: "{{ vector_config_dir }}/vector.yml"
          mode: "0644"
  